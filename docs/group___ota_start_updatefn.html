<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=9"/>
  <meta name="generator" content="Doxygen 1.8.16"/>
  <title>Harmony 3 : Wireless: m2m_ota_start_update</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
  <link href="customstylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
 <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
 <div id="titlearea">
 <table cellspacing="0" cellpadding="0">
 <tbody>
   <tr style="height: 56px;vertical-align: text-bottom;">
    <td style="padding: 0.2em 0.5em 0.1em 0.5em;">
	  <a id="projectlogo"><img alt="Logo" src="Microchip_logo.png"/> </a> </td>
     <td style="padding-right: 1em;">
       <span id="projectname"/> <class="stringliteral">Harmony 3 : Wireless </span>
     </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">m2m_ota_start_update<div class="ingroups"><a class="el" href="group__m2m__wifi.html">WLAN</a> &raquo; <a class="el" href="group___w_l_a_n_a_p_i.html">Functions</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga38a82b1bc3c43d3e48f8c4956b191ab1"><td class="memItemLeft" align="right" valign="top">int8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___ota_start_updatefn.html#ga38a82b1bc3c43d3e48f8c4956b191ab1">m2m_ota_start_update</a> (uint8_t *u8DownloadUrl)</td></tr>
<tr class="memdesc:ga38a82b1bc3c43d3e48f8c4956b191ab1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Request OTA start update using the downloaded url.  <a href="group___ota_start_updatefn.html#ga38a82b1bc3c43d3e48f8c4956b191ab1">More...</a><br /></td></tr>
<tr class="separator:ga38a82b1bc3c43d3e48f8c4956b191ab1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf1e631145f9a203642f877b002b2c306"><td class="memItemLeft" align="right" valign="top">int8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___ota_start_updatefn.html#gaf1e631145f9a203642f877b002b2c306">m2m_ota_start_update_crt</a> (uint8_t *u8DownloadUrl)</td></tr>
<tr class="memdesc:gaf1e631145f9a203642f877b002b2c306"><td class="mdescLeft">&#160;</td><td class="mdescRight">Request OTA start for the Cortus app image.  <a href="group___ota_start_updatefn.html#gaf1e631145f9a203642f877b002b2c306">More...</a><br /></td></tr>
<tr class="separator:gaf1e631145f9a203642f877b002b2c306"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Request OTA start update using the downloaded URL, the OTA module will download the OTA image and ensure integrity of the image, and update the validity of the image in control structure. Switching to that image requires calling <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware</a> API. As a prerequisite <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga80058af2f37ab262dbc1b5f5327708f7">m2m_ota_init</a> should be called before using m2m_ota_start().</p>
<p>Request OTA start for cortus application image using the downloaded URL, the OTA module will download the OTA image and ensure integrity of the image, and update the validity of the image in control structure. Switching to that image requires calling <a class="el" href="group___ota_switch_firmware.html#gacec240868c32daeb9c4dfbda209f0eb1">m2m_ota_switch_crt</a> API. As a prerequisite <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga80058af2f37ab262dbc1b5f5327708f7">m2m_ota_init</a> should be called before using <a class="el" href="group___ota_start_updatefn.html#gaf1e631145f9a203642f877b002b2c306">m2m_ota_start_update_crt()</a>. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga38a82b1bc3c43d3e48f8c4956b191ab1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga38a82b1bc3c43d3e48f8c4956b191ab1">&#9670;&nbsp;</a></span>m2m_ota_start_update()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int8_t m2m_ota_start_update </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>u8DownloadUrl</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Request OTA start update using the downloaded url. </p>
<p>Request OTA start update using the downloaded URL. The firmware OTA module will download the OTA image, ensure integrity of the image, and update the validity of the image in the control structure. On completion, a callback of type <a class="el" href="group___o_t_a_t_y_p_e_d_e_f.html#gaf345fdfae1cf9ce618873bb9ce7f3045">tpfOtaUpdateCb</a> is called (callback previously provided via <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init()</a>). Switching to the updated image additionally requires completion of <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware()</a>, and system_reset().</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">u8DownloadUrl</td><td>The download firmware URL, according to the application server.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section warning"><dt>Warning</dt><dd>Calling this API does not guarantee OTA WINC image update; it depends on the connection with the download server and the validity of the image. Calling this API invalidates the previous rollback image. The current image will become the rollback image after <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware()</a>.</dd></dl>
<dl class="section pre"><dt>Precondition</dt><dd><a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init()</a> must have been called before using <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaefb92e6e53637bd62b8371e7f00dd4eb">m2m_ota_start_update()</a>. </dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init()</a> <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware()</a> <a class="el" href="group___o_t_a_t_y_p_e_d_e_f.html#gaf345fdfae1cf9ce618873bb9ce7f3045">tpfOtaUpdateCb</a></dd></dl>
<dl class="section return"><dt>Returns</dt><dd>The function returns <a class="el" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a> for successful operations and a negative value otherwise. Note that successful operation in this context means the OTA update request has reached the firmware OTA module. It does not indicate whether or not the image update succeeded.</dd></dl>
<h1><a class="anchor" id="OTAExample"></a>
Example</h1>
<p>This example shows how an OTA image update and switch is carried out. It demonstrates use of the following OTA APIs: <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init()</a> <a class="el" href="group___o_t_a_t_y_p_e_d_e_f.html#gaf345fdfae1cf9ce618873bb9ce7f3045">tpfOtaUpdateCb</a> <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaefb92e6e53637bd62b8371e7f00dd4eb">m2m_ota_start_update()</a> <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware()</a> <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gad238a0b0d9218b8db10d82a95fc91dad">m2m_ota_rollback()</a> It also makes use of <a class="el" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaf649466de77518fe9eb35ed9a234bf32">m2m_wifi_check_ota_rb()</a> in order to inform OTA decisions.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> OtaUpdateCb(uint8_t u8OtaUpdateStatusType ,uint8_t u8OtaUpdateStatus)</div>
<div class="line">{</div>
<div class="line">    int8_t s8tmp;</div>
<div class="line">    <a class="code" href="structtstr_m2m_rev.html">tstrM2mRev</a> strtmp;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;%d %d\n&quot;</span>, u8OtaUpdateStatusType, u8OtaUpdateStatus);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span>(u8OtaUpdateStatusType) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aa9b634fb58a53969f9af8a89908e58c5e">DL_STATUS</a>:</div>
<div class="line">            <span class="keywordflow">if</span>(u8OtaUpdateStatus == <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#ggab7006b9cb55eb414d0416d0513533eeba23e293bcc679d3021e202ac255b71500">OTA_STATUS_SUCCESS</a>) {</div>
<div class="line">                <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;OTA download succeeded\n&quot;</span>);</div>
<div class="line">                s8tmp = <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaf649466de77518fe9eb35ed9a234bf32">m2m_wifi_check_ota_rb</a>();</div>
<div class="line">                <span class="keywordflow">if</span>(s8tmp == <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga589113b133769b3e1ef49b515d85364c">M2M_ERR_FW_VER_MISMATCH</a>) {</div>
<div class="line">                    <span class="comment">//  In this case the application SHOULD update the host driver before calling</span></div>
<div class="line">                    <span class="comment">//  @ref m2m_ota_switch_firmware(). Switching firmware image and resetting without updating host</span></div>
<div class="line">                    <span class="comment">//  driver would lead to severely limited functionality (i.e. OTA rollback only).</span></div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(s8tmp == <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a>) {</div>
<div class="line">                    <span class="comment">//  In this case the application MAY WANT TO update the host driver before calling</span></div>
<div class="line">                    <span class="comment">//  @ref m2m_ota_switch_firmware(). Switching firmware image and resetting without updating host</span></div>
<div class="line">                    <span class="comment">//  driver may lead to suboptimal functionality.</span></div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> {</div>
<div class="line">                    <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;Cannot recognize downloaded image\n&quot;</span>);</div>
<div class="line">                    <span class="comment">//  In this case the application MUST NOT update the host driver if such an update would change the</span></div>
<div class="line">                    <span class="comment">//  driver HIF Major field. Firmware switch @ref using m2m_ota_switch_firmware() is blocked.</span></div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;Now switching active partition...\n&quot;</span>);</div>
<div class="line">                s8tmp = <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware</a>();</div>
<div class="line">            }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aa2f1dabb326d861eadb5a5cd1b41962ff">SW_STATUS</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aad9b2f16f8c41c4108806a4c78dea422c">RB_STATUS</a>:</div>
<div class="line">            <span class="keywordflow">if</span>(u8OtaUpdateStatus == <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#ggab7006b9cb55eb414d0416d0513533eeba23e293bcc679d3021e202ac255b71500">OTA_STATUS_SUCCESS</a>) {</div>
<div class="line">                <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;Switch/Rollback succeeded\n&quot;</span>);</div>
<div class="line">                <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;Now resetting the system...\n&quot;</span>);</div>
<div class="line">                system_reset();</div>
<div class="line">            }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wifi_event_cb(uint8_t u8WiFiEvent, <span class="keywordtype">void</span> * pvMsg)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//  ...</span></div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___wlan_enums.html#gga064de09dec1d5e88ed8d075fa40f57deaa849449fa83e4b552689266a1f1019e7">M2M_WIFI_REQ_DHCP_CONF</a>:</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//After successful connection, start the OTA upgrade.</span></div>
<div class="line">        <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaefb92e6e53637bd62b8371e7f00dd4eb">m2m_ota_start_update</a>(OTA_URL);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="comment">//  ...</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    int8_t              ret = <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a>;</div>
<div class="line">    <a class="code" href="structtstr_wifi_init_param.html">tstrWifiInitParam</a>   param;</div>
<div class="line">    <span class="keywordtype">bool</span>                rollback_required = FALSE;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//  ... system init etc here ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Initialize the WINC Driver.</span></div>
<div class="line">    memset((uint8_t*)&amp;param, 0, <span class="keyword">sizeof</span>(param));</div>
<div class="line">    param.pfAppWifiCb = wifi_event_cb;</div>
<div class="line"> </div>
<div class="line">    ret = <a class="code" href="group___w_l_a_n_i_n_i_t.html#ga66f5bf5f84f898bdd4453f2717a3deb5">m2m_wifi_init</a>(&amp;param);</div>
<div class="line">    <span class="keywordflow">if</span>(ret == <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga589113b133769b3e1ef49b515d85364c">M2M_ERR_FW_VER_MISMATCH</a>) {</div>
<div class="line">        ret = <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaf649466de77518fe9eb35ed9a234bf32">m2m_wifi_check_ota_rb</a>();</div>
<div class="line">        <span class="keywordflow">if</span>(ret == <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a>) {</div>
<div class="line">            <span class="comment">//  In this case the image in the inactive partition has compatible HIF. We will switch/rollback to it</span></div>
<div class="line">            <span class="comment">//  after initializing the OTA module.</span></div>
<div class="line">            rollback_required = TRUE;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>(ret != <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a>) {</div>
<div class="line">        <a class="code" href="group___debug_defines.html#ga34d005df494e50b05cd38b80f318d7ac">M2M_ERR</a>(<span class="stringliteral">&quot;Driver Init Failed &lt;%d&gt;\n&quot;</span>,ret);</div>
<div class="line">        <span class="keywordflow">while</span>(1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Initialize the OTA module.</span></div>
<div class="line">    <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init</a>(OtaUpdateCb, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(rollback_required) {</div>
<div class="line">        <span class="comment">//  We need to call either @ref m2m_ota_rollback() or @ref m2m_ota_switch_firmware() (functionally equivalent).</span></div>
<div class="line">        <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gad238a0b0d9218b8db10d82a95fc91dad">m2m_ota_rollback</a>();</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">//  Connect to AP that provides connection to the OTA server</span></div>
<div class="line">        <a class="code" href="group___w_l_a_n_c_o_n_n_e_c_t.html#ga739abd39f7befa0da7bcea564a726141">m2m_wifi_default_connect</a>();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        <span class="comment">//  Handle the app state machine plus the WINC event handler.</span></div>
<div class="line">        <span class="keywordflow">while</span>(<a class="code" href="group___w_l_a_n_e_v_t_s.html#ga4f0db0a89400730ce569aa9e13a3108b">m2m_wifi_handle_events</a>(NULL) != <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a>) {</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">u8DownloadUrl</td><td>The download firmware URL, you get it from device info according to the application server</td></tr>
  </table>
  </dd>
</dl>
<dl class="section warning"><dt>Warning</dt><dd>Calling this API does not guarantee OTA WINC image update, It depends on the connection with the download server and the validity of the image. If the API response is failure this may invalidate the roll-back image if it was previously valid, since the WINC does not have any internal memory except the flash roll-back image location to validate the downloaded image from</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group___ota_init_fn.html#ga87960f1beeaec73ede1283ae058bfa39" title="Initialize the OTA layer.">m2m_ota_init</a> <a class="el" href="group___o_t_a_t_y_p_e_d_e_f.html#gaf345fdfae1cf9ce618873bb9ce7f3045">tpfOtaUpdateCb</a></dd></dl>
<dl class="section return"><dt>Returns</dt><dd>The function returns <a class="el" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a> for successful operations and a negative value otherwise. </dd></dl>
<h1><a class="anchor" id="Example"></a>
Example</h1>
<p>The example shows an example of how the OTA image update is carried out. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> OtaUpdateCb(uint8_t u8OtaUpdateStatusType ,uint8_t u8OtaUpdateStatus)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>(u8OtaUpdateStatusType == <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aa9b634fb58a53969f9af8a89908e58c5e">DL_STATUS</a>) {</div>
<div class="line">        <span class="keywordflow">if</span>(u8OtaUpdateStatus == <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#ggab7006b9cb55eb414d0416d0513533eeba23e293bcc679d3021e202ac255b71500">OTA_STATUS_SUCCESS</a>) {</div>
<div class="line">            <span class="comment">//switch to the upgraded firmware</span></div>
<div class="line">            <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware</a>();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(u8OtaUpdateStatusType == <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aa2f1dabb326d861eadb5a5cd1b41962ff">SW_STATUS</a>) {</div>
<div class="line">        <span class="keywordflow">if</span>(u8OtaUpdateStatus == <a class="code" href="group___o_t_a_t_y_p_e_d_e_f.html#ggab7006b9cb55eb414d0416d0513533eeba23e293bcc679d3021e202ac255b71500">OTA_STATUS_SUCCESS</a>) {</div>
<div class="line">            <a class="code" href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a>(<span class="stringliteral">&quot;Now OTA successfully done&quot;</span>);</div>
<div class="line">            <span class="comment">//start the host SW upgrade then system reset is required (Reinitialize the driver)</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> wifi_event_cb(uint8_t u8WiFiEvent, <span class="keywordtype">void</span> * pvMsg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___wlan_enums.html#gga064de09dec1d5e88ed8d075fa40f57deaa849449fa83e4b552689266a1f1019e7">M2M_WIFI_REQ_DHCP_CONF</a>:</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//after successfully connection, start the over air upgrade</span></div>
<div class="line">        <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaefb92e6e53637bd62b8371e7f00dd4eb">m2m_ota_start_update</a>(OTA_URL);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structtstr_wifi_init_param.html">tstrWifiInitParam</a> param;</div>
<div class="line">    <a class="code" href="structtstr1x_auth_credentials.html">tstr1xAuthCredentials</a> gstrCred1x    = AUTH_CREDENTIALS;</div>
<div class="line">    nm_bsp_init();</div>
<div class="line"> </div>
<div class="line">    memset((uint8_t*)&amp;param, 0, <span class="keyword">sizeof</span>(param));</div>
<div class="line">    param.pfAppWifiCb = wifi_event_cb;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Initialize the WINC Driver</span></div>
<div class="line">    ret = <a class="code" href="group___w_l_a_n_i_n_i_t.html#ga66f5bf5f84f898bdd4453f2717a3deb5">m2m_wifi_init</a>(&amp;param);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a> != ret)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group___debug_defines.html#ga34d005df494e50b05cd38b80f318d7ac">M2M_ERR</a>(<span class="stringliteral">&quot;Driver Init Failed &lt;%d&gt;\n&quot;</span>,ret);</div>
<div class="line">        <span class="keywordflow">while</span>(1);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">//Initialize the OTA module</span></div>
<div class="line">    <a class="code" href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init</a>(OtaUpdateCb,NULL);</div>
<div class="line">    <span class="comment">//connect to AP that provide connection to the OTA server</span></div>
<div class="line">    <a class="code" href="group___w_l_a_n_c_o_n_n_e_c_t.html#ga739abd39f7befa0da7bcea564a726141">m2m_wifi_default_connect</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">//Handle the app state machine plus the WINC event handler</span></div>
<div class="line">        <span class="keywordflow">while</span>(<a class="code" href="group___w_l_a_n_e_v_t_s.html#ga4f0db0a89400730ce569aa9e13a3108b">m2m_wifi_handle_events</a>(NULL) != <a class="code" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a>) {</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">u8DownloadUrl</td><td>The download firmware url, you get it from device info</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The function SHALL return 0 for success and a negative value otherwise. </dd></dl>

</div>
</div>
<a id="gaf1e631145f9a203642f877b002b2c306"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf1e631145f9a203642f877b002b2c306">&#9670;&nbsp;</a></span>m2m_ota_start_update_crt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int8_t m2m_ota_start_update_crt </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>u8DownloadUrl</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Request OTA start for the Cortus app image. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">u8DownloadUrl</td><td>The cortus application image url. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section warning"><dt>Warning</dt><dd>Calling this API does not guarantee cortus application image update, It depends on the connection with the download server and the validity of the image. If the API response is failure this may invalidate the roll-back image if it was previously valid, since the WINC does not have any internal memory except the flash roll-back image location to validate the downloaded image from</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group___ota_init_fn.html#ga87960f1beeaec73ede1283ae058bfa39" title="Initialize the OTA layer.">m2m_ota_init</a> <a class="el" href="group___o_t_a_t_y_p_e_d_e_f.html#gaf345fdfae1cf9ce618873bb9ce7f3045">tpfOtaUpdateCb</a></dd></dl>
<dl class="section return"><dt>Returns</dt><dd>The function returns <a class="el" href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a> for successful operations and a negative value otherwise.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">u8DownloadUrl</td><td>The cortus application image url.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The function SHALL return 0 for success and a negative value otherwise. </dd></dl>

</div>
</div>
</div><!-- contents -->
<div class="ttc" id="agroup___o_t_a_f_u_n_c_t_i_o_n_s_html_ga08275ebf9834c5223311bc8ae9627959"><div class="ttname"><a href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga08275ebf9834c5223311bc8ae9627959">m2m_ota_init</a></div><div class="ttdeci">int8_t m2m_ota_init(tpfOtaUpdateCb pfOtaUpdateCb, tpfOtaNotifCb pfOtaNotifCb, tpfFileGetCb pfHFDGetCb)</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_ota.c:188</div></div>
<div class="ttc" id="agroup___debug_defines_html_ga34d005df494e50b05cd38b80f318d7ac"><div class="ttname"><a href="group___debug_defines.html#ga34d005df494e50b05cd38b80f318d7ac">M2M_ERR</a></div><div class="ttdeci">#define M2M_ERR(...)</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/common/nm_debug.h:45</div></div>
<div class="ttc" id="agroup___o_t_a_t_y_p_e_d_e_f_html_gga3e56744d263918b9e36016f78d823c3aa9b634fb58a53969f9af8a89908e58c5e"><div class="ttname"><a href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aa9b634fb58a53969f9af8a89908e58c5e">DL_STATUS</a></div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_types.h:2648</div></div>
<div class="ttc" id="agroup___o_t_a_t_y_p_e_d_e_f_html_ggab7006b9cb55eb414d0416d0513533eeba23e293bcc679d3021e202ac255b71500"><div class="ttname"><a href="group___o_t_a_t_y_p_e_d_e_f.html#ggab7006b9cb55eb414d0416d0513533eeba23e293bcc679d3021e202ac255b71500">OTA_STATUS_SUCCESS</a></div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_types.h:2615</div></div>
<div class="ttc" id="agroup___w_l_a_n_e_v_t_s_html_ga4f0db0a89400730ce569aa9e13a3108b"><div class="ttname"><a href="group___w_l_a_n_e_v_t_s.html#ga4f0db0a89400730ce569aa9e13a3108b">m2m_wifi_handle_events</a></div><div class="ttdeci">int8_t m2m_wifi_handle_events(void)</div><div class="ttdoc">Synchronous M2M event handler function.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_wifi.c:497</div></div>
<div class="ttc" id="agroup___debug_defines_html_ga84108eca2655e811179386a39c62acf2"><div class="ttname"><a href="group___debug_defines.html#ga84108eca2655e811179386a39c62acf2">M2M_INFO</a></div><div class="ttdeci">#define M2M_INFO(...)</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/common/nm_debug.h:46</div></div>
<div class="ttc" id="astructtstr_m2m_rev_html"><div class="ttname"><a href="structtstr_m2m_rev.html">tstrM2mRev</a></div><div class="ttdoc">Structure holding firmware version parameters and build date/time.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/nmdrv.h:46</div></div>
<div class="ttc" id="agroup___o_t_a_t_y_p_e_d_e_f_html_gga3e56744d263918b9e36016f78d823c3aad9b2f16f8c41c4108806a4c78dea422c"><div class="ttname"><a href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aad9b2f16f8c41c4108806a4c78dea422c">RB_STATUS</a></div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_types.h:2654</div></div>
<div class="ttc" id="agroup___o_t_a_f_u_n_c_t_i_o_n_s_html_gaf649466de77518fe9eb35ed9a234bf32"><div class="ttname"><a href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaf649466de77518fe9eb35ed9a234bf32">m2m_wifi_check_ota_rb</a></div><div class="ttdeci">int8_t m2m_wifi_check_ota_rb(void)</div><div class="ttdoc">Synchronous API to check presence and compatibility of the WINC image that is stored in the inactive ...</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc3400/driver/winc/drv/driver/m2m_wifi.c:1654</div></div>
<div class="ttc" id="agroup___c_o_m_m_o_n_d_e_f_html_ga9ef27ba27aafdd1aa3a79d3ba2c36b8f"><div class="ttname"><a href="group___c_o_m_m_o_n_d_e_f.html#ga9ef27ba27aafdd1aa3a79d3ba2c36b8f">M2M_SUCCESS</a></div><div class="ttdeci">#define M2M_SUCCESS</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/common/nm_common.h:48</div></div>
<div class="ttc" id="agroup___o_t_a_f_u_n_c_t_i_o_n_s_html_ga24e44fbce7ca42ded0e1daa500c40ca8"><div class="ttname"><a href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#ga24e44fbce7ca42ded0e1daa500c40ca8">m2m_ota_switch_firmware</a></div><div class="ttdeci">int8_t m2m_ota_switch_firmware(void)</div><div class="ttdoc">Switch to the upgraded Firmware.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_ota.c:332</div></div>
<div class="ttc" id="agroup___wlan_enums_html_gga064de09dec1d5e88ed8d075fa40f57deaa849449fa83e4b552689266a1f1019e7"><div class="ttname"><a href="group___wlan_enums.html#gga064de09dec1d5e88ed8d075fa40f57deaa849449fa83e4b552689266a1f1019e7">M2M_WIFI_REQ_DHCP_CONF</a></div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_types.h:977</div></div>
<div class="ttc" id="agroup___w_l_a_n_c_o_n_n_e_c_t_html_ga739abd39f7befa0da7bcea564a726141"><div class="ttname"><a href="group___w_l_a_n_c_o_n_n_e_c_t.html#ga739abd39f7befa0da7bcea564a726141">m2m_wifi_default_connect</a></div><div class="ttdeci">int8_t m2m_wifi_default_connect(void)</div><div class="ttdoc">Asynchronous API that attempts to reconnect to the last-associated access point.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_wifi.c:510</div></div>
<div class="ttc" id="astructtstr1x_auth_credentials_html"><div class="ttname"><a href="structtstr1x_auth_credentials.html">tstr1xAuthCredentials</a></div><div class="ttdoc">This struct stores the credentials for the user to authenticate with the AAA server (WPA-Enterprise M...</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_wifi.h:322</div></div>
<div class="ttc" id="agroup___o_t_a_t_y_p_e_d_e_f_html_gga3e56744d263918b9e36016f78d823c3aa2f1dabb326d861eadb5a5cd1b41962ff"><div class="ttname"><a href="group___o_t_a_t_y_p_e_d_e_f.html#gga3e56744d263918b9e36016f78d823c3aa2f1dabb326d861eadb5a5cd1b41962ff">SW_STATUS</a></div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_types.h:2651</div></div>
<div class="ttc" id="agroup___c_o_m_m_o_n_d_e_f_html_ga589113b133769b3e1ef49b515d85364c"><div class="ttname"><a href="group___c_o_m_m_o_n_d_e_f.html#ga589113b133769b3e1ef49b515d85364c">M2M_ERR_FW_VER_MISMATCH</a></div><div class="ttdeci">#define M2M_ERR_FW_VER_MISMATCH</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/common/nm_common.h:61</div></div>
<div class="ttc" id="agroup___o_t_a_f_u_n_c_t_i_o_n_s_html_gaefb92e6e53637bd62b8371e7f00dd4eb"><div class="ttname"><a href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gaefb92e6e53637bd62b8371e7f00dd4eb">m2m_ota_start_update</a></div><div class="ttdeci">int8_t m2m_ota_start_update(unsigned char *pcDownloadUrl)</div><div class="ttdoc">Request OTA start update using the downloaded URL.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_ota.c:277</div></div>
<div class="ttc" id="agroup___o_t_a_f_u_n_c_t_i_o_n_s_html_gad238a0b0d9218b8db10d82a95fc91dad"><div class="ttname"><a href="group___o_t_a_f_u_n_c_t_i_o_n_s.html#gad238a0b0d9218b8db10d82a95fc91dad">m2m_ota_rollback</a></div><div class="ttdeci">int8_t m2m_ota_rollback(void)</div><div class="ttdoc">Request OTA Rollback image.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_ota.c:298</div></div>
<div class="ttc" id="astructtstr_wifi_init_param_html"><div class="ttname"><a href="structtstr_wifi_init_param.html">tstrWifiInitParam</a></div><div class="ttdoc">Structure, holding the Wi-fi configuration attributes such as the wi-fi callback ,...</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/include/drv/driver/m2m_wifi.h:293</div></div>
<div class="ttc" id="agroup___w_l_a_n_i_n_i_t_html_ga66f5bf5f84f898bdd4453f2717a3deb5"><div class="ttname"><a href="group___w_l_a_n_i_n_i_t.html#ga66f5bf5f84f898bdd4453f2717a3deb5">m2m_wifi_init</a></div><div class="ttdeci">int8_t m2m_wifi_init(tstrWifiInitParam *pWifiInitParam)</div><div class="ttdoc">Synchronous API to initialize the WINC driver.</div><div class="ttdef"><b>Definition:</b> apps/ap_scan/firmware/src/config/sam_d21_xpro_winc1500/driver/winc/drv/driver/m2m_wifi.c:475</div></div>
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer">
  <span class="stringliteral"> © 2019 Microchip Technology Inc. </span>
</body>
</html>
